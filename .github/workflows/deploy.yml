name: CI/CD Pipeline  # Name of the workflow shown in GitHub Actions tab

on:
  push:
    branches:
      - main  # Trigger the workflow whenever code is pushed to the 'main' branch

jobs:
  build-and-deploy:  # Define a job named 'build-and-deploy'
    runs-on: ubuntu-latest  # Run the job on the latest Ubuntu GitHub-hosted runner
    
    steps:
      - name: Checkout code  # Step 1: Fetch the repository code
        uses: actions/checkout@v3  # Official GitHub Action to clone your repo into the workflow runner

      - name: Log in to Docker Hub  # Step 2: Authenticate with Docker Hub
        uses: docker/login-action@v2  # GitHub Action for logging into Docker Hub
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # Docker Hub username stored securely in repo secrets
          password: ${{ secrets.DOCKER_PASSWORD }}  # Docker Hub password/token stored in secrets

      - name: Build & push backend  # Step 3: Build backend image and push to Docker Hub
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/backend:v1 ./backend  # Build backend image from backend directory
          docker push ${{ secrets.DOCKER_USERNAME }}/backend:v1  # Push backend image to Docker Hub

      - name: Build & push frontend  # Step 4: Build frontend image and push to Docker Hub
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/frontend:v1 ./frontend  # Build frontend image from frontend directory
          docker push ${{ secrets.DOCKER_USERNAME }}/frontend:v1  # Push frontend image to Docker Hub

      - name: Deploy to Azure VM  # Step 5: Deploy both containers to your remote Azure VM
        uses: appleboy/ssh-action@master  # Action to execute SSH commands on a remote server
        with:
          host: ${{ secrets.VM_HOST }}  # Azure VM public IP or hostname
          username: ${{ secrets.VM_USER }}  # SSH username for your VM
          key: ${{ secrets.VM_SSH_KEY }}  # Private SSH key stored in secrets
          script: |  # Commands to execute remotely via SSH
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/backend:v1  # Pull latest backend image from Docker Hub
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/frontend:v1  # Pull latest frontend image from Docker Hub
            
            # Stop and remove old containers if they exist (avoids name conflicts)
            sudo docker stop backend_container || true
            sudo docker rm backend_container || true
            sudo docker stop frontend_container || true
            sudo docker rm frontend_container || true
            
            # Run new backend container with required environment variables
            sudo docker run -d --name backend_container \
              -e MONGODB_URL='mongodb+srv://admin:admin123@appproject.fc9xifh.mongodb.net/?appName=appproject' \  # MongoDB connection URL
              -e ACCESS_TOKEN_SECRET='Rj2S?RVe9[]8-dCS6A**&b5Tsg$gwbg~Bd{*QTK' \  # Secret key for JWT authentication
              ${{ secrets.DOCKER_USERNAME }}/backend:v1  # Run the backend container from the pulled image
            
            sleep 10  # Wait 10 seconds to ensure backend container is fully up before starting frontend
            
            # Run new frontend container and link it to the backend
            sudo docker run -d --name frontend_container \
              --link backend_container \  # Link frontend with backend for internal communication
              -p 80:80 \  # Map port 80 of the VM to port 80 of the frontend container
              ${{ secrets.DOCKER_USERNAME }}/frontend:v1  # Run the frontend container from the pulled image
